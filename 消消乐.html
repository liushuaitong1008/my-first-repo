<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹æ—æ¶ˆæ¶ˆä¹</title>
	  <meta name="description" content="ç»ƒä¹ ç”¨html">
	  <meta name="keywords" content="æ¶ˆæ¶ˆä¹">
	  <meta name="author" content="æ©˜çŒ«æ¶ˆæ¶ˆä¹ - www.baidu.com">	
	  <link rel="shortcut icon" href=""> 
	  <script>
	  var _hmt = _hmt || [];
	  (function() {
	    var hm = document.createElement("script");
	    hm.src = "https://hm.baidu.com/hm.js?a9430a37066911650e26adadcc42798a";
	    var s = document.getElementsByTagName("script")[0]; 
	    s.parentNode.insertBefore(hm, s);
	  })();
	  </script>
	  <script charset="UTF-8" id="LA_COLLECT" src="https://sdk.51.la/js-sdk-pro.min.js"></script>
	  <script>LA.init({id:"JxVJPIpe3UAQqoDx",ck:"JxVJPIpe3UAQqoDx"})</script>
	      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7056167681359419"
	       crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5dc;
            color: #5a3921;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #main-container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
        }
        #game-container {
            flex: 1;
            max-width: 500px;
            background-color: #fff9e6;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
    /*@media (min-width: 901px) {*/
    /*    #game-container {*/
    /*        margin-left: 18%;*/
    /*    }*/
    /*}        */
    
    @media (min-width: 901px) {
        #rules-sidebar {
            margin-left: 5%;
        }
    }        
        #leaderboard-sidebar {
            width: 450px;
            background-color: #fff9e6;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #8b4513;
            margin-bottom: 5px;
            text-align: center;
        }
        #stats {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            font-weight: bold;
        }
        .stat {
            background-color: rgba(210, 180, 140, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }
        #grid {
            display: grid;
            grid-template-columns: repeat(5, 60px);
            grid-gap: 5px;
            justify-content: center;
            margin: 20px 0;
        }
        .cell {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        .cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        /* èœå“ç­‰çº§é¢œè‰² - ç²‰è‰²ç´«è‰²ç³» */
        .lvl1 { background-color: #ffcdd2; color: #5a3921; }
        .lvl2 { background-color: #f8bbd0; color: #5a3921; }
        .lvl3 { background-color: #e1bee7; color: #5a3921; }
        .lvl4 { background-color: #d1c4e9; color: #5a3921; }
        .lvl5 { background-color: #c5cae9; color: #5a3921; }
        .lvl6 { background-color: #bbdefb; color: #5a3921; }
        .lvl7 { background-color: #b3e5fc; color: #5a3921; }
        .lvl8 { background-color: #b2ebf2; color: #5a3921; }
        .lvl9 { background-color: #b2dfdb; color: #5a3921; }
        .lvl10 { background-color: #c8e6c9; color: #5a3921; }
        .lvl11 { background-color: #dcedc8; color: #5a3921; }
        .lvl12 { background-color: #f0f4c3; color: #5a3921; }
        .lvl13 { background-color: #fff9c4; color: #5a3921; }
        .lvl14 { background-color: #ffecb3; color: #5a3921; }
        .lvl15 { background-color: #ffe0b2; color: #5a3921; }
        #message {
            min-height: 24px;
            color: #8b4513;
            font-style: italic;
            text-align: center;
        }
        button {
            background-color: #8d6e63;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #6d4c41;
        }
        /* æ¨¡å¼é€‰æ‹©æ ·å¼ */
        #mode-selection {
            margin: 15px 0;
            text-align: center;
        }
        .mode-btn {
            padding: 10px 20px;
            font-size: 16px;
            margin: 0 10px;
        }
        /* æ¸¸æˆç»“æŸå¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff9e6;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
        }
        .modal h2 {
            color: #8b4513;
        }
        #username-input {
            padding: 8px;
            margin: 10px 0;
            width: 80%;
            border-radius: 5px;
            border: 1px solid #8d6e63;
        }
        /* æ’è¡Œæ¦œæ ·å¼ */
        #leaderboard-content {
            flex: 1;
            overflow-y: auto;
        }
        #leaderboard-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .leaderboard-tab {
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .leaderboard-tab.active {
            border-bottom: 2px solid #8b4513;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #d2b48c;
            text-align: center;
        }
        th {
            background-color: rgba(210, 180, 140, 0.3);
        }
        tr:nth-child(even) {
            background-color: rgba(210, 180, 140, 0.1);
        }
        @media (max-width: 900px) {
            #main-container {
                flex-direction: column;
            }
            #leaderboard-sidebar {
                width: auto;
            }
        }
        #leaderboard-status {
            margin-top: 10px;
            font-size: 12px;
            color: #8b4513;
            text-align: center;
            font-style: italic;
        }
        /* æ— å°½æ¨¡å¼æäº¤æŒ‰é’® */
        #endless-submit-btn {
            display: none;
        }
        
        #rules-sidebar {
    width: 250px;
    background-color: #fff9e6;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    font-size: 14px;
    color: #5a3921;
    flex-shrink: 0;
}

#rules-sidebar h2,
#rules-mobile h2 {
    margin-top: 0;
    color: #8b4513;
    font-size: 18px;
    text-align: center;
}

#rules-sidebar ul,
#rules-mobile ul {
    padding-left: 20px;
}

@media (max-width: 900px) {
    #rules-sidebar {
        display: none;
    }
    #rules-mobile {
        display: block !important;
    }
}

 /* åƒç´ é£æ ¼æŒ‰é’® */
 .more-games-btn {
   position: fixed;
   top: 120px;
   right: 20px;
   z-index: 9999;
   display: block;
   width: 48px;
   height: 48px;
   background: #4cc9f0;
   border: 4px solid #2b2d42;
   border-radius: 8px;
   color: white;
   font-size: 24px;
   text-align: center;
   line-height: 48px;
   text-decoration: none;
   box-shadow: 4px 4px 0 #2b2d42;
   transition: all 0.2s ease;
   cursor: pointer;
 }
 
 .more-games-btn::after {
   content: "æ›´å¤šæ¸¸æˆ";
   position: absolute;
   right: 60px;
   top: 50%;
   transform: translateY(-50%); /* è¿™å·²ç»ç¡®ä¿æ•´ä½“æ¡†å‚ç›´å±…ä¸­ */
   white-space: nowrap;
   background: #2b2d42;
   color: white;
   padding: 8px 12px; /* è°ƒæ•´ä¸Šä¸‹paddingä½¿æ–‡å­—å±…ä¸­ */
   border-radius: 4px;
   font-size: 14px;
   line-height: 1; /* å…³é”®ï¼šé‡ç½®è¡Œé«˜ä¸º1 */
   opacity: 0;
   transition: opacity 0.3s ease;
   pointer-events: none;
   border: 2px solid #4cc9f0;
   display: flex; /* æ–°å¢ï¼šä½¿ç”¨flexå¸ƒå±€ç¡®ä¿å®Œç¾å±…ä¸­ */
   align-items: center; /* æ–°å¢ï¼šå‚ç›´å±…ä¸­ */
   justify-content: center; /* æ–°å¢ï¼šæ°´å¹³å±…ä¸­ */
   height: auto; /* ç§»é™¤å›ºå®šé«˜åº¦ */
 }
 
 .more-games-btn:hover {
   transform: translate(2px, 2px);
   box-shadow: 2px 2px 0 #2b2d42;
   background: #4895ef;
 }
 
 .more-games-btn:hover::after {
   opacity: 1;
 }
    </style>
<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id:"KsK4gEK6tdiW31X5",ck:"KsK4gEK6tdiW31X5"})</script>
</head>
<body>
    <div id="main-container">
     <div id="rules-sidebar">
        <h2>æ¸¸æˆè§„åˆ™</h2>
        <ul>
            <li>ç‚¹å‡»ä¸€ä¸ªæ–¹å—ï¼Œå®ƒå°†å‡çº§ä¸€çº§ã€‚</li>
            <li>ä¸‰ä¸ªæˆ–ä»¥ä¸Šç›¸é‚»åŒç­‰çº§æ–¹å—å°†è‡ªåŠ¨åˆæˆæ›´é«˜çº§æ–¹å—ã€‚</li>
            <li>æ¯æ¬¡ç‚¹å‡»ä¼šæ¶ˆè€—ä¸€æ¬¡ç§»åŠ¨ï¼ˆæ™®é€šæ¨¡å¼ï¼‰ã€‚</li>
            <li>æ— å°½æ¨¡å¼ä¸­æ²¡æœ‰ç§»åŠ¨é™åˆ¶ï¼Œä½†éœ€æ‰‹åŠ¨æäº¤åˆ†æ•°ã€‚</li>
            <li>åº·å“¥è¯•ä¸€ä¸‹ğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜ŠğŸ˜Š</li>
        </ul>
    </div>
        <div id="game-container">
            <h1> ä¹æ—æ¶ˆæ¶ˆä¹ </h1>
            <p style="text-align: center;">ç‚¹å‡»å‡çº§ï¼Œä¸‰ä¸ªç›¸é‚»è‡ªåŠ¨åˆæˆï¼Œä¸Šæ–¹æ‰è½æ–¹å—</p>
            
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div id="mode-selection">
                <button class="mode-btn" id="normal-mode-btn">æ™®é€šæ¨¡å¼</button>
                <button class="mode-btn" id="endless-mode-btn">æ— å°½æ¨¡å¼</button>
            </div>
            
            <div id="stats">
                <div class="stat">æœ€é«˜ç­‰çº§: <span id="max-level">0</span></div>
                <div class="stat">åˆ†æ•°: <span id="score">0</span></div>
                <div class="stat" id="moves-container">å‰©ä½™æ¬¡æ•°: <span id="moves-left">30</span></div>
            </div>
            
            <div id="grid"></div>
            
            <div id="message"></div>
            
<div style="display: flex; justify-content: center; gap: 10px;">
    <button id="restart-btn">é‡æ–°å¼€å§‹</button>
    <button id="endless-submit-btn">æäº¤å½“å‰åˆ†æ•°</button>
</div>
        </div>

        <!-- æ’è¡Œæ¦œä¾§è¾¹æ  -->
        <div id="leaderboard-sidebar">
            <h2>æ’è¡Œæ¦œ - <span id="leaderboard-mode">æ™®é€šæ¨¡å¼ï¼ˆæœ‰bugï¼‰</span></h2>
            <div id="leaderboard-tabs">
                <div class="leaderboard-tab active" data-period="daily">æ—¥æ¦œ</div>
                <div class="leaderboard-tab" data-period="weekly">å‘¨æ¦œ</div>
                <div class="leaderboard-tab" data-period="monthly">æœˆæ¦œ</div>
                <div class="leaderboard-tab" data-period="alltime">æ€»æ¦œ</div>
            </div>
            <div id="leaderboard-content">
                <table>
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>ç”¨æˆ·å</th>
                            <th>åˆ†æ•°</th>
                            <th>æœ€é«˜ç­‰çº§</th>
                            <th>æ—¥æœŸ</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- æ’è¡Œæ¦œæ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                        <tr><td colspan="5">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="leaderboard-status">æœ€åæ›´æ–°: --</div>
            <div id="rules-mobile" style="display: none; margin-top: 20px;">
                <h2>æ¸¸æˆè§„åˆ™</h2>
                <ul>
                    <li>ç‚¹å‡»ä¸€ä¸ªèœå“ï¼Œå®ƒå°†å‡çº§ä¸€çº§ã€‚</li>
                    <li>ä¸‰ä¸ªæˆ–ä»¥ä¸Šç›¸é‚»åŒç­‰çº§èœå“å°†è‡ªåŠ¨åˆæˆæ›´é«˜çº§èœã€‚</li>
                    <li>æ¯æ¬¡ç‚¹å‡»ä¼šæ¶ˆè€—ä¸€æ¬¡ç§»åŠ¨ï¼ˆæ™®é€šæ¨¡å¼ï¼‰ã€‚</li>
                    <li>æ— å°½æ¨¡å¼ä¸­æ²¡æœ‰ç§»åŠ¨é™åˆ¶ï¼Œä½†éœ€æ‰‹åŠ¨æäº¤åˆ†æ•°ã€‚</li>
                    
                </ul>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
    <div class="modal" id="game-over-modal">
        <div class="modal-content">
            <h2>æ¸¸æˆç»“æŸ!</h2>
            <p>ä½ çš„æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span></p>
            <p>æœ€é«˜ç­‰çº§: <span id="final-level">0</span></p>
            <input type="text" id="username-input" placeholder="è¾“å…¥ç”¨æˆ·å" maxlength="20">
            <div>
                <button id="submit-score-btn">æäº¤åˆ†æ•°</button>
                <button id="cancel-submit-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <script>
        // æ¸¸æˆé…ç½®
        const config = {
            gridSize: 5,
            maxLevel: 15,
            maxMoves: 30,
            leaderboardFile: "leaderboard.txt", // æ’è¡Œæ¦œæ•°æ®æ–‡ä»¶
            maxEntries: 100 // æœ€å¤§æ’è¡Œæ¦œæ¡ç›®æ•°
        };
        
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            maxLevel: 0,
            score: 0,
            grid: [],
            processing: false,
            movesLeft: config.maxMoves,
            gameMode: 'normal', // 'normal' æˆ– 'endless'
            gameActive: false
        };
        
        // æ’è¡Œæ¦œæ•°æ®
        let leaderboardData = {
            normal: {
                daily: [],
                weekly: [],
                monthly: [],
                alltime: []
            },
            endless: {
                daily: [],
                weekly: [],
                alltime: []
            }
        };
        
        // DOMå…ƒç´ 
        const gridEl = document.getElementById('grid');
        const maxLevelEl = document.getElementById('max-level');
        const scoreEl = document.getElementById('score');
        const movesLeftEl = document.getElementById('moves-left');
        const movesContainerEl = document.getElementById('moves-container');
        const messageEl = document.getElementById('message');
        const restartBtn = document.getElementById('restart-btn');
        const normalModeBtn = document.getElementById('normal-mode-btn');
        const endlessModeBtn = document.getElementById('endless-mode-btn');
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreEl = document.getElementById('final-score');
        const finalLevelEl = document.getElementById('final-level');
        const usernameInput = document.getElementById('username-input');
        const submitScoreBtn = document.getElementById('submit-score-btn');
        const cancelSubmitBtn = document.getElementById('cancel-submit-btn');
        const leaderboardModeEl = document.getElementById('leaderboard-mode');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const leaderboardTabs = document.querySelectorAll('.leaderboard-tab');
        const leaderboardStatusEl = document.getElementById('leaderboard-status');
        const endlessSubmitBtn = document.getElementById('endless-submit-btn');
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            gameState.maxLevel = 0;
            gameState.score = 0;
            gameState.grid = Array(config.gridSize * config.gridSize).fill(0);
            gameState.processing = false;
            gameState.movesLeft = config.maxMoves;
            gameState.gameActive = true;
            
            maxLevelEl.textContent = gameState.maxLevel;
            scoreEl.textContent = gameState.score;
            movesLeftEl.textContent = gameState.movesLeft;
            messageEl.textContent = '';
            
            // æ˜¾ç¤º/éšè—ç§»åŠ¨æ¬¡æ•°
            movesContainerEl.style.display = gameState.gameMode === 'normal' ? 'block' : 'none';
            
            // æ˜¾ç¤º/éšè—æ— å°½æ¨¡å¼æäº¤æŒ‰é’®
            endlessSubmitBtn.style.display = gameState.gameMode === 'endless' ? 'block' : 'none';
            
            // åˆå§‹åŒ–ç½‘æ ¼
            renderGrid();
            
            // ç”Ÿæˆåˆå§‹å¸ƒå±€(ç¡®ä¿æ²¡æœ‰å¯ç›´æ¥åˆæˆçš„)
            generateInitialLayout();
            
            // åŠ è½½æ’è¡Œæ¦œæ•°æ®
            loadLeaderboard();
        }
        
        // ç”Ÿæˆåˆå§‹å¸ƒå±€(ç¡®ä¿æ²¡æœ‰3ä¸ªæˆ–ä»¥ä¸Šç›¸è¿)
        function generateInitialLayout() {
            // é¦–å…ˆç”Ÿæˆéšæœºå¸ƒå±€
            for (let i = 0; i < gameState.grid.length; i++) {
                gameState.grid[i] = Math.floor(Math.random() * 3) + 1;
            }
            
            // æ£€æŸ¥å¹¶ä¿®å¤å¯èƒ½å­˜åœ¨çš„åˆå§‹åˆæˆ
            let hasMatches = true;
            let attempts = 0;
            const maxAttempts = 100;
            
            while (hasMatches && attempts < maxAttempts) {
                hasMatches = false;
                
                // æ£€æŸ¥æ‰€æœ‰æ ¼å­
                for (let i = 0; i < gameState.grid.length; i++) {
                    const group = findConnectedGroup(i);
                    if (group.length >= 3) {
                        // æ‰¾åˆ°åŒ¹é…ï¼Œéšæœºæ”¹å˜å…¶ä¸­ä¸€ä¸ªæ ¼å­çš„å€¼
                        const randomIndex = group[Math.floor(Math.random() * group.length)];
                        gameState.grid[randomIndex] = Math.floor(Math.random() * 3) + 1;
                        hasMatches = true;
                        break;
                    }
                }
                
                attempts++;
            }
            
            // æ›´æ–°ç½‘æ ¼æ˜¾ç¤º
            for (let i = 0; i < gameState.grid.length; i++) {
                updateCell(i);
            }
        }
        
        // æ¸²æŸ“æ¸¸æˆç½‘æ ¼
        function renderGrid() {
            gridEl.innerHTML = '';
            
            for (let i = 0; i < config.gridSize * config.gridSize; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.addEventListener('click', () => handleCellClick(i));
                gridEl.appendChild(cell);
            }
        }
        
        // æ›´æ–°æ ¼å­æ˜¾ç¤º
        function updateCell(index) {
            const cell = gridEl.children[index];
            const level = gameState.grid[index];
            
            // ç§»é™¤æ‰€æœ‰ç­‰çº§ç±»
            for (let i = 1; i <= config.maxLevel; i++) {
                cell.classList.remove(`lvl${i}`);
            }
            
            if (level > 0) {
                // æ·»åŠ æ–°ç­‰çº§ç±»
                cell.classList.add(`lvl${Math.min(level, 15)}`);
                cell.textContent = level;
                cell.style.opacity = '1';
                cell.style.backgroundColor = '';
            } else {
                // ç©ºæ ¼å­
                cell.textContent = '';
                cell.style.backgroundColor = 'transparent';
                cell.style.opacity = '0.3';
            }
        }
        
        // å¤„ç†æ ¼å­ç‚¹å‡»
        function handleCellClick(index) {
            if (!gameState.gameActive || gameState.processing || gameState.grid[index] === 0) return;
            
            // åœ¨æ™®é€šæ¨¡å¼ä¸‹æ£€æŸ¥å‰©ä½™æ¬¡æ•°
            if (gameState.gameMode === 'normal') {
                if (gameState.movesLeft <= 0) {
                    showMessage("æ¸¸æˆç»“æŸ! æ¬¡æ•°å·²ç”¨å®Œ");
                    endGame();
                    return;
                }
                gameState.movesLeft--;
                movesLeftEl.textContent = gameState.movesLeft;
            }
            
            // æå‡ç­‰çº§
            gameState.grid[index]++;
            updateMaxLevel(gameState.grid[index]);
            updateCell(index);
            
            // æ’­æ”¾åŠ¨ç”»
            const cell = gridEl.children[index];
            cell.style.transform = 'scale(1.2)';
            setTimeout(() => {
                cell.style.transform = '';
            }, 200);
            
            // æ£€æŸ¥å¹¶å¤„ç†ç›¸é‚»åŒ¹é…
            checkAndProcessMatches();
        }
        
        // æ›´æ–°æœ€é«˜ç­‰çº§
        function updateMaxLevel(level) {
            if (level > gameState.maxLevel) {
                gameState.maxLevel = level;
                maxLevelEl.textContent = gameState.maxLevel;
            }
        }
        
        // æ›´æ–°åˆ†æ•°
        function updateScore(points) {
            gameState.score += points;
            scoreEl.textContent = gameState.score;
        }
        
        // æ£€æŸ¥å¹¶å¤„ç†ç›¸é‚»åŒ¹é…
        function checkAndProcessMatches() {
            gameState.processing = true;
            let matchesFound = false;
            const processed = new Set();
            
            // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…ç»„
            for (let i = 0; i < gameState.grid.length; i++) {
                if (processed.has(i) || gameState.grid[i] === 0) continue;
                
                const group = findConnectedGroup(i);
                if (group.length >= 3) {
                    matchesFound = true;
                    processMatch(group);
                    group.forEach(idx => processed.add(idx));
                }
            }
            
            if (matchesFound) {
                // å¤„ç†ä¸‹è½å’Œæ–°æ ¼å­
                setTimeout(processFallAndNewDishes, 500);
            } else {
                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ (æ™®é€šæ¨¡å¼ä¸”æ²¡æœ‰ç§»åŠ¨æ¬¡æ•°)
                if (gameState.gameMode === 'normal' && gameState.movesLeft <= 0) {
                    setTimeout(() => {
                        endGame();
                    }, 500);
                } else {
                    gameState.processing = false;
                }
            }
        }
        
        // æŸ¥æ‰¾ç›¸è¿çš„ç›¸åŒç­‰çº§ç»„
        function findConnectedGroup(startIndex) {
            const targetLevel = gameState.grid[startIndex];
            const visited = new Set();
            const queue = [startIndex];
            
            while (queue.length > 0) {
                const current = queue.shift();
                if (visited.has(current)) continue;
                
                visited.add(current);
                const neighbors = getNeighbors(current);
                
                for (const neighbor of neighbors) {
                    if (gameState.grid[neighbor] === targetLevel) {
                        queue.push(neighbor);
                    }
                }
            }
            
            return Array.from(visited);
        }
        
        // è·å–ç›¸é‚»æ ¼å­ç´¢å¼•
        function getNeighbors(index) {
            const neighbors = [];
            const row = Math.floor(index / config.gridSize);
            const col = index % config.gridSize;
            
            // ä¸Š
            if (row > 0) neighbors.push(index - config.gridSize);
            // ä¸‹
            if (row < config.gridSize - 1) neighbors.push(index + config.gridSize);
            // å·¦
            if (col > 0) neighbors.push(index - 1);
            // å³
            if (col < config.gridSize - 1) neighbors.push(index + 1);
            
            return neighbors;
        }
        
        // å¤„ç†åŒ¹é…çš„èœå“ç»„
        function processMatch(group) {
            if (group.length < 3) return;
            
            const baseLevel = gameState.grid[group[0]];
            
            // é€‰æ‹©ç¬¬ä¸€ä¸ªä½œä¸ºåˆæˆä½ç½®
            const targetIndex = group[0];
            // å‡çº§å…¬å¼ï¼š3ä¸ªå‡1çº§ï¼Œæ¯å¤š1ä¸ªé¢å¤–å‡1çº§
            const levelIncrease = 1 + Math.max(0, group.length - 3);
            const newLevel = baseLevel + levelIncrease;
            
            // è®¡ç®—åˆ†æ•° = åŸºç¡€ç­‰çº§ Ã— æ•°é‡ Ã— 10
            const points = baseLevel * group.length * 10;
            updateScore(points);
            
            gameState.grid[targetIndex] = newLevel;
            updateMaxLevel(newLevel);
            updateCell(targetIndex);
            
            // æ’­æ”¾åˆæˆåŠ¨ç”»
            const targetCell = gridEl.children[targetIndex];
            targetCell.style.transform = 'scale(1.3)';
            setTimeout(() => {
                targetCell.style.transform = '';
            }, 300);
            
            // å…¶ä»–åŒ¹é…æ ¼å­è®¾ä¸ºç©º
            for (let i = 1; i < group.length; i++) {
                gameState.grid[group[i]] = 0;
                updateCell(group[i]);
            }
            
            showMessage(`${group.length}ä¸ª${baseLevel}çº§åˆæˆ${newLevel}çº§ï¼Œè·å¾—${points}åˆ†`);
        }
        
        // å¤„ç†ä¸‹è½å’Œæ–°èœå“
        function processFallAndNewDishes() {
            // å¤„ç†ä¸‹è½ - æŒ‰åˆ—å¤„ç†
            for (let col = 0; col < config.gridSize; col++) {
                const emptySlots = [];
                
                // ä»ä¸‹å¾€ä¸Šæ£€æŸ¥
                for (let row = config.gridSize - 1; row >= 0; row--) {
                    const index = row * config.gridSize + col;
                    
                    if (gameState.grid[index] === 0) {
                        emptySlots.push(index);
                    } else if (emptySlots.length > 0) {
                        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½
                        const emptyIndex = emptySlots.shift();
                        
                        // ç§»åŠ¨èœå“
                        gameState.grid[emptyIndex] = gameState.grid[index];
                        gameState.grid[index] = 0;
                        
                        // æ›´æ–°æ˜¾ç¤º
                        updateCell(index);
                        updateCell(emptyIndex);
                        
                        // æ’­æ”¾ä¸‹è½åŠ¨ç”»
                        const movingCell = gridEl.children[emptyIndex];
                        movingCell.style.transform = 'translateY(-100%)';
                        movingCell.style.transition = 'transform 1.5s';
                        
                        setTimeout(() => {
                            movingCell.style.transform = '';
                            movingCell.style.transition = '';
                        }, 10);
                        
                        // å°†å½“å‰ä½ç½®åŠ å…¥ç©ºä½åˆ—è¡¨
                        emptySlots.push(index);
                    }
                }
                
                // å¡«å……é¡¶éƒ¨ç©ºä½
                for (const emptyIndex of emptySlots) {
                    setTimeout(() => {
                        gameState.grid[emptyIndex] = Math.floor(Math.random() * 3) + 1;
                        updateCell(emptyIndex);
                        
                        // æ–°èœå“åŠ¨ç”»
                        const newCell = gridEl.children[emptyIndex];
                        newCell.style.transform = 'scale(0.5)';
                        newCell.style.opacity = '0';
                        
                        setTimeout(() => {
                            newCell.style.transform = '';
                            newCell.style.opacity = '1';
                        }, 100);
                    }, 100 * (emptySlots.indexOf(emptyIndex) + 1));
                }
            }
            
            // æ£€æŸ¥æ–°çš„åŒ¹é…
            setTimeout(() => {
                checkAndProcessMatches();
            }, 500);
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(msg) {
            messageEl.textContent = msg;
            setTimeout(() => {
                if (messageEl.textContent === msg) {
                    messageEl.textContent = '';
                }
            }, 2000);
        }
        
        // æ¸¸æˆç»“æŸ
        function endGame() {
            gameState.gameActive = false;
            finalScoreEl.textContent = gameState.score;
            finalLevelEl.textContent = gameState.maxLevel;
            gameOverModal.style.display = 'flex';
        }
        
        // æäº¤åˆ†æ•°åˆ°æ’è¡Œæ¦œ
        async function submitScore() {
            const username = usernameInput.value.trim();
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            const now = new Date();
            const scoreData = {
                username: username,
                score: gameState.score,
                maxLevel: gameState.maxLevel,
                date: now.toISOString(),
                timestamp: now.getTime(),
                mode: gameState.gameMode
            };
            
            // å…³é—­å¼¹çª—
            gameOverModal.style.display = 'none';
            usernameInput.value = '';
            
            // ä¿å­˜åˆ†æ•°åˆ°æœåŠ¡å™¨
            try {
                await saveScoreToServer(scoreData);
                showMessage("åˆ†æ•°å·²æäº¤!");
                // é‡æ–°åŠ è½½æ’è¡Œæ¦œ
                loadLeaderboard();
            } catch (error) {
                console.error("æäº¤åˆ†æ•°å¤±è´¥:", error);
                showMessage("æäº¤åˆ†æ•°å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }
        
        // ä¿å­˜åˆ†æ•°åˆ°æœåŠ¡å™¨
        async function saveScoreToServer(scoreData) {
            // è·å–ç°æœ‰æ’è¡Œæ¦œæ•°æ®
            const currentData = await fetchLeaderboardData();
            
            // æ·»åŠ æ–°åˆ†æ•°
            currentData.push(scoreData);
            
            // æŒ‰åˆ†æ•°æ’åº
            currentData.sort((a, b) => b.score - a.score);
            
            // é™åˆ¶æœ€å¤§æ¡ç›®æ•°
            if (currentData.length > config.maxEntries) {
                currentData.length = config.maxEntries;
            }
            
            // è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼
            const txtContent = currentData.map(entry => 
                `${entry.mode}|${entry.username}|${entry.score}|${entry.maxLevel}|${entry.timestamp}`
            ).join('\n');
            
            // å‘é€åˆ°æœåŠ¡å™¨ä¿å­˜
            const formData = new FormData();
            formData.append('data', txtContent);
            formData.append('filename', config.leaderboardFile);
            
            const response = await fetch('save_leaderboard.php', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('ä¿å­˜å¤±è´¥');
            }
        }
        
        // ä»æœåŠ¡å™¨åŠ è½½æ’è¡Œæ¦œæ•°æ®
        async function loadLeaderboard() {
            try {
                const rawData = await fetchLeaderboardData();
                
                // æ¸…ç©ºç°æœ‰æ•°æ®
                leaderboardData = {
                    normal: { daily: [], weekly: [], monthly: [], alltime: [] },
                    endless: { daily: [], weekly: [], monthly: [], alltime: [] }
                };
                
                // å½“å‰æ—¶é—´
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                
                // å¤„ç†æ•°æ®
                rawData.forEach(entry => {
                    const entryDate = new Date(entry.timestamp);
                    
                    // æ·»åŠ åˆ°æ€»æ¦œ
                    leaderboardData[entry.mode].alltime.push(entry);
                    
                    // æ·»åŠ åˆ°æœˆæ¦œ
                    if (entryDate >= monthAgo) {
                        leaderboardData[entry.mode].monthly.push(entry);
                    }
                    
                    // æ·»åŠ åˆ°å‘¨æ¦œ
                    if (entryDate >= weekAgo) {
                        leaderboardData[entry.mode].weekly.push(entry);
                    }
                    
                    // æ·»åŠ åˆ°æ—¥æ¦œ
                    if (entryDate >= today) {
                        leaderboardData[entry.mode].daily.push(entry);
                    }
                });
                
                // æ’åºæ¯ä¸ªæ’è¡Œæ¦œ
                for (const mode in leaderboardData) {
                    for (const period in leaderboardData[mode]) {
                        leaderboardData[mode][period].sort((a, b) => b.score - a.score);
                    }
                }
                
                // æ›´æ–°æ˜¾ç¤º
// æ›´æ–°æ˜¾ç¤º
showLeaderboard();
leaderboardStatusEl.innerHTML = `æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()} | made by æ©˜çŒ« | å¥½ç©çˆ±ç©å˜¿å˜¿ï¼š<a href="www.baidu.com" style="color: #8b4513;">www.baidu.com</a>`;
            } catch (error) {
                console.error("åŠ è½½æ’è¡Œæ¦œå¤±è´¥:", error);
                leaderboardBody.innerHTML = '<tr><td colspan="5">åŠ è½½æ’è¡Œæ¦œå¤±è´¥</td></tr>';
                leaderboardStatusEl.textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
            }
        }
        
        // ä»æœåŠ¡å™¨è·å–æ’è¡Œæ¦œåŸå§‹æ•°æ®
        async function fetchLeaderboardData() {
            try {
                const response = await fetch(`${config.leaderboardFile}?t=${Date.now()}`);
                if (!response.ok) {
                    throw new Error('è·å–æ•°æ®å¤±è´¥');
                }
                
                const text = await response.text();
                if (!text.trim()) {
                    return [];
                }
                
                // è§£ææ–‡æœ¬æ•°æ®
                return text.split('\n').filter(line => line.trim()).map(line => {
                    const [mode, username, score, maxLevel, timestamp] = line.split('|');
                    return {
                        mode,
                        username,
                        score: parseInt(score),
                        maxLevel: parseInt(maxLevel),
                        timestamp: parseInt(timestamp),
                        date: new Date(parseInt(timestamp)).toISOString()
                    };
                });
            } catch (error) {
                console.error("è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥:", error);
                return [];
            }
        }
        
        // æ˜¾ç¤ºæ’è¡Œæ¦œ
        function showLeaderboard(period = 'daily') {
            leaderboardModeEl.textContent = gameState.gameMode === 'normal' ? 'æ™®é€šæ¨¡å¼' : 'æ— å°½æ¨¡å¼';
            
            // æ›´æ–°æ´»è·ƒæ ‡ç­¾
            leaderboardTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.period === period);
            });
            
            // è·å–å½“å‰æ’è¡Œæ¦œæ•°æ®
            const currentLeaderboard = leaderboardData[gameState.gameMode][period];
            
            // æ¸…ç©ºè¡¨æ ¼
            leaderboardBody.innerHTML = '';
            
            // å¡«å……æ•°æ®
            if (currentLeaderboard.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5">æš‚æ— æ•°æ®</td>`;
                leaderboardBody.appendChild(row);
            } else {
                currentLeaderboard.slice(0, 20).forEach((entry, index) => {
                    const row = document.createElement('tr');
                    const date = new Date(entry.timestamp);
                    const dateStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${entry.username}</td>
                        <td>${entry.score}</td>
                        <td>${entry.maxLevel}</td>
                        <td>${dateStr}</td>
                    `;
                    leaderboardBody.appendChild(row);
                });
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        restartBtn.addEventListener('click', initGame);
        
        normalModeBtn.addEventListener('click', () => {
            gameState.gameMode = 'normal';
            initGame();
        });
        
        endlessModeBtn.addEventListener('click', () => {
            gameState.gameMode = 'endless';
            initGame();
        });
        
        submitScoreBtn.addEventListener('click', submitScore);
        
        cancelSubmitBtn.addEventListener('click', () => {
            gameOverModal.style.display = 'none';
            usernameInput.value = '';
        });
        
        leaderboardTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                showLeaderboard(tab.dataset.period);
            });
        });
        
        // æ— å°½æ¨¡å¼æäº¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        endlessSubmitBtn.addEventListener('click', () => {
            if (gameState.gameActive && gameState.gameMode === 'endless') {
                endGame();
            }
        });
        
        // åˆå§‹åŒ–æ¸¸æˆ (é»˜è®¤æ™®é€šæ¨¡å¼)
        gameState.gameMode = 'normal';
        
        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
    </script>

</body>
</html>